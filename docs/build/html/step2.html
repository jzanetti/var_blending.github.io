
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="English">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Step 2 run Variational blending &#8212; var_blending_docs 0.0.1 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/my_theme.css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Step 1 Preparing model errors" href="step1.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="step1.html" title="Step 1 Preparing model errors"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">var_blending_docs 0.0.1 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="step-2-run-variational-blending">
<h1>Step 2 run Variational blending<a class="headerlink" href="#step-2-run-variational-blending" title="Permalink to this headline">¶</a></h1>
<p>We may start blending the global model (e.g., GFS) and LAM model (e.g., WRF)
together by either using:</p>
<ul class="simple">
<li>Using the model errors estimated from STEP 1</li>
<li>Using the user defined model errors</li>
</ul>
<p>However, we need to consider that:</p>
<ul>
<li><p class="first">if the LAM forecasts has similar magnitude to the global forecasts
(e.g., LAM already has strong large scale forcing, or LAM contains a
large scale system like a frontal precipitation),
the use of blended analysis may lead to worse results
(the noises introduced by the blending is larger than the
errors inherent in the LAM forecasts)</p>
<p>The blending process would only happen if:</p>
</li>
<li><p class="first">LAM forecasts (over lands) are not very wet</p>
</li>
<li><p class="first">Large scale power ratio in LAM is not that big</p>
</li>
</ul>
<div class="section" id="step-2-1-determine-the-model-blending-criteria">
<h2>STEP 2.1 Determine the model blending criteria<a class="headerlink" href="#step-2-1-determine-the-model-blending-criteria" title="Permalink to this headline">¶</a></h2>
<div class="section" id="step-2-1-1-obtain-lam-maximum-reflectivity">
<h3>STEP 2.1.1 obtain LAM maximum reflectivity:<a class="headerlink" href="#step-2-1-1-obtain-lam-maximum-reflectivity" title="Permalink to this headline">¶</a></h3>
<p>The following codes show the method of obtaining <code class="docutils literal notranslate"><span class="pre">mdbz</span></code> and <code class="docutils literal notranslate"><span class="pre">topo</span></code> from a model data:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ncfile</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">datapath</span><span class="p">)</span>
<span class="n">mdbz</span> <span class="o">=</span> <span class="n">getvar</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="s1">&#39;mdbz&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
<span class="n">topo</span> <span class="o">=</span> <span class="n">getvar</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="s2">&quot;HGT&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
<span class="n">ncfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>The following figures show <code class="docutils literal notranslate"><span class="pre">mdbz</span></code> and <code class="docutils literal notranslate"><span class="pre">topo</span></code>:</p>
<a class="reference internal image-reference" href="_images/mdbz.png"><img alt="_images/mdbz.png" src="_images/mdbz.png" style="width: 600px;" /></a>
<a class="reference internal image-reference" href="_images/topo.png"><img alt="_images/topo.png" src="_images/topo.png" style="width: 600px;" /></a>
</div>
<div class="section" id="step-2-1-2-obtain-welch-model-power-over-latitudes">
<h3>STEP 2.1.2 obtain Welch model power over latitudes<a class="headerlink" href="#step-2-1-2-obtain-welch-model-power-over-latitudes" title="Permalink to this headline">¶</a></h3>
<p>The codes for calculating the Welch's power over latitude are:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># the ratio of the large scale information in dbz</span>
<span class="n">data_shape</span> <span class="o">=</span> <span class="n">mdbz</span><span class="o">.</span><span class="n">shape</span>
<span class="n">model_power_along_lat</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">cur_dbz</span> <span class="o">=</span> <span class="n">mdbz</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">model_power_along_lat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">welch</span><span class="p">(</span>
        <span class="n">cur_dbz</span><span class="p">,</span> <span class="n">nperseg</span><span class="o">=</span><span class="n">data_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">model_power_along_lat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">model_power_along_lat</span><span class="p">)</span>
<span class="n">model_power_along_lat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">model_power_along_lat</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>The following figure show the mean Welch power over latitudes</p>
<a class="reference internal image-reference" href="_images/model_power_along_lat.png"><img alt="_images/model_power_along_lat.png" src="_images/model_power_along_lat.png" style="width: 600px;" /></a>
</div>
<div class="section" id="step-2-1-3-obtain-the-large-scale-power-ratio-over-the-total-power">
<h3>STEP 2.1.3 Obtain the large scale power ratio over the total power:<a class="headerlink" href="#step-2-1-3-obtain-the-large-scale-power-ratio-over-the-total-power" title="Permalink to this headline">¶</a></h3>
<p>The codes for calculating the large scale power ratio over the total power are:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">total_power</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">model_power_along_lat</span><span class="p">)</span>
<span class="n">large_scale_power</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">model_power_along_lat</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">max_wavenumber</span><span class="p">])</span>
<span class="n">large_scale_power_ratio</span> <span class="o">=</span> <span class="n">large_scale_power</span><span class="o">/</span><span class="n">total_power</span>
</pre></div>
</div>
<p>In the above codes, <cite>max_wavenumber</cite> is usually determined by the distances
between two ratiosondes. For example, in the above case, we have
<code class="docutils literal notranslate"><span class="pre">total_power=134480.78</span></code>, <code class="docutils literal notranslate"><span class="pre">large_scale_power=42747.742</span></code> therefore
<code class="docutils literal notranslate"><span class="pre">large_scale_power_ratio=0.3178725</span></code></p>
</div>
<div class="section" id="step-2-1-4-obtain-the-wet-ratio-over-lands">
<h3>STEP 2.1.4 Obtain the wet ratio over lands<a class="headerlink" href="#step-2-1-4-obtain-the-wet-ratio-over-lands" title="Permalink to this headline">¶</a></h3>
<p>The codes for calculating the wet ratio over lands are:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># the ratio of rainfall areas over lands</span>
<span class="n">mdbz</span><span class="p">[</span><span class="n">topo</span> <span class="o">&lt;</span> <span class="n">lowest_land_height</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">NaN</span>
<span class="n">wet_points</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">mdbz</span> <span class="o">&gt;</span> <span class="n">lowest_dbz_consider_dry</span><span class="p">)</span>
<span class="n">dry_points</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">mdbz</span> <span class="o">&lt;</span> <span class="n">lowest_dbz_consider_dry</span><span class="p">)</span>
<span class="n">wet_ratio</span> <span class="o">=</span> <span class="n">wet_points</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">dry_points</span> <span class="o">+</span> <span class="n">wet_points</span><span class="p">)</span>
</pre></div>
</div>
<p>The maximum dBZ over lands are shown as:</p>
<a class="reference internal image-reference" href="_images/mdbz_lands.png"><img alt="_images/mdbz_lands.png" src="_images/mdbz_lands.png" style="width: 600px;" /></a>
<p>In the above example, we have <code class="docutils literal notranslate"><span class="pre">wet_points=4257</span></code>, <code class="docutils literal notranslate"><span class="pre">dry_points=12262</span></code>,
therefore <code class="docutils literal notranslate"><span class="pre">wet_ratio=0.2577</span></code>.</p>
</div>
<div class="section" id="step-2-1-5-blending-criteria">
<h3>STEP 2.1.5 Blending criteria<a class="headerlink" href="#step-2-1-5-blending-criteria" title="Permalink to this headline">¶</a></h3>
<p>The blending will only be carried out if:</p>
<ul class="simple">
<li><dl class="first docutils">
<dt>LAM forecasts large scale forcing is not that strong:</dt>
<dd><ul class="first last">
<li><code class="docutils literal notranslate"><span class="pre">large_scale_power_ratio</span></code> &lt; <code class="docutils literal notranslate"><span class="pre">WET_CRITERIAS['max_allowed_large_scale_power']</span></code>, and</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>LAM forecasts are not that wet:</dt>
<dd><ul class="first last">
<li><code class="docutils literal notranslate"><span class="pre">wet_ratio</span> <span class="pre">&lt;</span> <span class="pre">WET_CRITERIAS</span></code> &lt; <code class="docutils literal notranslate"><span class="pre">WET_CRITERIAS['max_allowed_wet_ratio']</span></code></li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>The codes determining the blending criteria are:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">max_allowed_large_scale_power_from_hist</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">max_allowed_wet_ratio_from_hist</span><span class="p">):</span>
    <span class="c1"># used in the step of checking the data for creating errors</span>
    <span class="k">if</span> <span class="n">large_scale_power_ratio</span> <span class="o">&lt;</span> <span class="n">WET_CRITERIAS</span><span class="p">[</span><span class="s1">&#39;max_allowed_large_scale_power&#39;</span><span class="p">]</span> \
            <span class="ow">and</span> <span class="n">wet_ratio</span> <span class="o">&lt;</span> <span class="n">WET_CRITERIAS</span><span class="p">[</span><span class="s1">&#39;max_allowed_wet_ratio&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">large_scale_power_ratio</span><span class="p">,</span> <span class="n">wet_ratio</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">large_scale_power_ratio</span><span class="p">,</span> <span class="n">wet_ratio</span>
</pre></div>
</div>
<p>Note that it is suggested to use the consistent <code class="docutils literal notranslate"><span class="pre">WET_CRITERIAS</span></code> in both
blending process and model error estimation.</p>
</div>
</div>
<div class="section" id="step-2-2-load-model-data-the-model-errors-and-auxiliary-files">
<h2>STEP 2.2 Load model data, the model errors and auxiliary files<a class="headerlink" href="#step-2-2-load-model-data-the-model-errors-and-auxiliary-files" title="Permalink to this headline">¶</a></h2>
<div class="section" id="step-2-2-1-load-model-forecasts">
<h3>STEP 2.2.1 Load model forecasts<a class="headerlink" href="#step-2-2-1-load-model-forecasts" title="Permalink to this headline">¶</a></h3>
<p>First we load the forecasts from a global, and LAM model:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lam_data</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">var_bld_err_processing</span><span class="o">.</span><span class="n">obtain_griddata</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">lam_fcst</span><span class="p">,</span> <span class="n">cur_model_var</span><span class="p">)</span>
<span class="n">glb_data</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">var_bld_err_processing</span><span class="o">.</span><span class="n">obtain_griddata</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">glb_fcst</span><span class="p">,</span> <span class="n">cur_model_var</span><span class="p">)</span>
</pre></div>
</div>
<p>As an example, the following figures show the forecasts from WRF and GFS at the level of 0:</p>
<a class="reference internal image-reference" href="_images/var_bld_lam.png"><img alt="_images/var_bld_lam.png" src="_images/var_bld_lam.png" style="width: 400px;" /></a>
<a class="reference internal image-reference" href="_images/var_bld_glb.png"><img alt="_images/var_bld_glb.png" src="_images/var_bld_glb.png" style="width: 400px;" /></a>
</div>
<div class="section" id="step-2-2-2-compare-the-current-and-historical-power-differences-between-lam-and-global-models">
<h3>STEP 2.2.2 Compare the current and historical power differences between LAM and global models<a class="headerlink" href="#step-2-2-2-compare-the-current-and-historical-power-differences-between-lam-and-global-models" title="Permalink to this headline">¶</a></h3>
<p>Here we compare the current difference between LAM and global models to the
one obtained from the process of estimating the model errors.</p>
<p>If the current difference is smaller than the historical one
(the smallest one, at each level, in all used historical cases),
the blending would not be continued.</p>
<div class="section" id="step-2-2-2-1-load-historical-power-difference-between-lam-and-global-models">
<h4>STEP 2.2.2.1 Load historical power difference between LAM and global models<a class="headerlink" href="#step-2-2-2-1-load-historical-power-difference-between-lam-and-global-models" title="Permalink to this headline">¶</a></h4>
<p>The following codes show how to calculate the difference between LAM and global
models in terms of power spectrum:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">hist_power_diff</span> <span class="o">=</span> <span class="n">var_bld_process</span><span class="o">.</span><span class="n">obtain_hist_power_diff</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">cur_model_var</span><span class="p">)</span>
</pre></div>
</div>
<p>For example, in the above example, we can have <code class="docutils literal notranslate"><span class="pre">hist_power_diff</span></code> as:</p>
<p><code class="docutils literal notranslate"><span class="pre">[3.891983</span>&#160;&#160; <span class="pre">7.9804535</span>&#160; <span class="pre">3.0878906</span> <span class="pre">.....</span> <span class="pre">0.03034592</span> <span class="pre">0.67630005</span> <span class="pre">0.23221588</span> <span class="pre">6.340851</span> <span class="pre">]</span></code></p>
<p>with the length as the total model levels.</p>
<a class="reference internal image-reference" href="_images/var_bld_hist_power_diff.png"><img alt="_images/var_bld_hist_power_diff.png" src="_images/var_bld_hist_power_diff.png" style="width: 600px;" /></a>
</div>
<div class="section" id="step-2-2-2-2-load-current-power-difference-between-lam-and-global-models">
<h4>STEP 2.2.2.2 Load current power difference between LAM and global models<a class="headerlink" href="#step-2-2-2-2-load-current-power-difference-between-lam-and-global-models" title="Permalink to this headline">¶</a></h4>
<p>We also load the powers of the current LAM and global models,
and obtain the difference <code class="docutils literal notranslate"><span class="pre">cur_power_diff</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">obtain_cur_power_diff</span><span class="p">(</span><span class="n">lam_data</span><span class="p">,</span> <span class="n">glb_data</span><span class="p">,</span> <span class="n">max_wavenumber</span><span class="p">,</span> <span class="n">total_model_levels</span><span class="p">):</span>
    <span class="n">cur_gdata_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">cur_gdata_dict</span><span class="p">[</span><span class="s1">&#39;lam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">cur_gdata_dict</span><span class="p">[</span><span class="s1">&#39;glb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">cur_gdata_dict</span><span class="p">[</span><span class="s1">&#39;lam&#39;</span><span class="p">][</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">lam_data</span>
    <span class="n">cur_gdata_dict</span><span class="p">[</span><span class="s1">&#39;glb&#39;</span><span class="p">][</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">glb_data</span>
    <span class="n">power_spectrum_welch_lam</span> <span class="o">=</span> <span class="n">fft_process</span><span class="o">.</span><span class="n">obtain_power_spectrum_using_welch</span><span class="p">(</span>
        <span class="n">cur_gdata_dict</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">MODELTYPES</span><span class="p">,</span>
        <span class="n">total_model_levels</span><span class="p">,</span> <span class="n">max_wavenumber</span><span class="p">)</span>
    <span class="n">cur_power_diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">power_spectrum_welch_lam</span><span class="p">[</span><span class="s1">&#39;lam&#39;</span><span class="p">][</span><span class="mi">12</span><span class="p">]</span> <span class="o">-</span>
                         <span class="n">power_spectrum_welch_lam</span><span class="p">[</span><span class="s1">&#39;glb&#39;</span><span class="p">][</span><span class="mi">12</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">cur_power_diff</span>
</pre></div>
</div>
<p>As the above section, we can have <code class="docutils literal notranslate"><span class="pre">cur_power_diff</span></code> as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mf">2.4575073e+01</span> <span class="mf">2.2306580e+01</span> <span class="mf">1.3234039e+01</span> <span class="o">......</span> <span class="mf">5.0335388e+00</span> <span class="mf">1.3680725e+00</span><span class="p">]</span>
</pre></div>
</div>
<p>with the length as the total model levels</p>
<a class="reference internal image-reference" href="_images/var_bld_cur_power_diff.png"><img alt="_images/var_bld_cur_power_diff.png" src="_images/var_bld_cur_power_diff.png" style="width: 600px;" /></a>
</div>
<div class="section" id="step-2-2-2-3-compare-the-historical-and-current-power-differences">
<h4>STEP 2.2.2.3 Compare the historical and current power differences<a class="headerlink" href="#step-2-2-2-3-compare-the-historical-and-current-power-differences" title="Permalink to this headline">¶</a></h4>
<p>If the current power difference is larger than the historical smallest one,
the blending will be continued at such particular level</p>
<a class="reference internal image-reference" href="_images/var_bld_power_diff.png"><img alt="_images/var_bld_power_diff.png" src="_images/var_bld_power_diff.png" style="width: 600px;" /></a>
</div>
</div>
<div class="section" id="step-2-2-3-load-model-errors">
<h3>STEP 2.2.3 Load model errors<a class="headerlink" href="#step-2-2-3-load-model-errors" title="Permalink to this headline">¶</a></h3>
<p>The following codes show the way of loading the model errors:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">use_fix_wavenumber</span><span class="p">:</span>
    <span class="n">cur_err_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">args</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="s1">&#39;model_errs_</span><span class="si">{}</span><span class="s1">.tar.gz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur_model_var</span><span class="p">))</span>
    <span class="n">cur_err</span> <span class="o">=</span> <span class="n">var_bld_process</span><span class="o">.</span><span class="n">load_error</span><span class="p">(</span><span class="n">cur_err_path</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">cur_err</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
<p>The structure of <code class="docutils literal notranslate"><span class="pre">cur_err</span></code> is</p>
<p><code class="docutils literal notranslate"><span class="pre">cur_err[VALID_TIME]</span> <span class="pre">=&gt;</span> <span class="pre">cur_err[VALID_TIME]['lam'/'glb']</span> <span class="pre">=&gt;</span> <span class="pre">cur_err[VALID_TIME]['lam'/'glb'][forecast_lead_hour]</span></code></p>
<p>The data shape is consistent with the shape of grid data, e.g., we would have:
<code class="docutils literal notranslate"><span class="pre">cur_err['2018100512']['lam'][12].shape</span> <span class="pre">=</span> <span class="pre">(50,</span> <span class="pre">519,</span> <span class="pre">423)</span></code></p>
</div>
<div class="section" id="step-2-2-4-load-user-defined-error-ratio-profile-and-update-model-errors">
<h3>STEP 2.2.4 Load user defined error ratio profile and update model errors<a class="headerlink" href="#step-2-2-4-load-user-defined-error-ratio-profile-and-update-model-errors" title="Permalink to this headline">¶</a></h3>
<p>When we use the prior estimated model errors, we also have a user
defined error ratio vertical profile. For example</p>
<p><strong>1. we have the original errors of:</strong></p>
<ol class="arabic simple">
<li>For a WRF model:</li>
</ol>
<ul class="simple">
<li><dl class="first docutils">
<dt>LAM: at level 15:</dt>
<dd><ul class="first last">
<li>wavenumber1: 0.8, wavenumber15: 0.3</li>
</ul>
</dd>
</dl>
</li>
</ul>
<ol class="arabic simple" start="2">
<li>For a GFS model:</li>
</ol>
<ul class="simple">
<li><dl class="first docutils">
<dt>GFS: at level 15:</dt>
<dd><ul class="first last">
<li>wavenumber1: 0.2, wavenumber15: 0.75</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p><strong>2. The user defined error ratio vertical profile:</strong></p>
<ul class="simple">
<li><dl class="first docutils">
<dt>at level 15:</dt>
<dd><ul class="first last">
<li>LAM err profile: 0.7;</li>
<li>GFS err profile: 0.1</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p><strong>3. So the final model error is:</strong></p>
<ol class="arabic simple">
<li>For WRF final error:</li>
</ol>
<ul class="simple">
<li><dl class="first docutils">
<dt>LAM: at level 15:</dt>
<dd><ul class="first last">
<li>wavenumber1: 0.8 * 0.7 = 0.56</li>
<li>wavenumber15: 0.3 * 0.7 = 0.21</li>
</ul>
</dd>
</dl>
</li>
</ul>
<ol class="arabic simple" start="2">
<li>For GFS final error:</li>
</ol>
<ul class="simple">
<li><dl class="first docutils">
<dt>GFS: at level 15:</dt>
<dd><ul class="first last">
<li>wavenumber1: 0.2 * 0.1 = 0.02</li>
<li>wavenumber15: 0.75 * 0.1 = 0.075</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>The codes to do this are:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_update_model_error</span><span class="p">(</span>
        <span class="n">cur_glb_error</span><span class="p">,</span> <span class="n">cur_lam_error</span><span class="p">,</span>
        <span class="n">glb_model_err_ratio</span><span class="p">,</span> <span class="n">lam_model_err_ratio</span><span class="p">):</span>
    <span class="n">cur_glb_error</span> <span class="o">=</span> <span class="n">cur_glb_error</span> <span class="o">*</span> <span class="n">glb_model_err_ratio</span>
    <span class="n">cur_lam_error</span> <span class="o">=</span> <span class="n">cur_lam_error</span> <span class="o">*</span> <span class="n">lam_model_err_ratio</span>

    <span class="k">return</span> <span class="n">cur_glb_error</span><span class="p">,</span> <span class="n">cur_lam_error</span>
</pre></div>
</div>
<p>The output shape of the model errors (e.g., either <cite>1cur_glb_error`1 or `1cur_lam_error`</cite>)
is the shape of grid data (e.g., <code class="docutils literal notranslate"><span class="pre">cur_glb_error.shape</span> <span class="pre">=</span> <span class="pre">(519,</span> <span class="pre">423)</span></code>)</p>
</div>
<div class="section" id="step-2-2-5-convert-model-errors-from-an-array-to-a-matrix">
<h3>STEP 2.2.5 convert model errors from an array to a matrix<a class="headerlink" href="#step-2-2-5-convert-model-errors-from-an-array-to-a-matrix" title="Permalink to this headline">¶</a></h3>
<p>Then we need to convert the errors from above to a matrix:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vector_out</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">matrix_in</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">matrix_in</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">vector_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matrix_in</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>

<span class="k">return</span> <span class="n">vector_out</span>
</pre></div>
</div>
<p>For example, if the original shape of model error is <code class="docutils literal notranslate"><span class="pre">matrix_in.shape</span> <span class="pre">=</span> <span class="pre">(519,</span> <span class="pre">423)</span></code> will
become <code class="docutils literal notranslate"><span class="pre">vector_out.shape</span> <span class="pre">=</span> <span class="pre">(219537,)</span></code></p>
</div>
<div class="section" id="step-2-2-6-create-the-final-error-matrix">
<h3>STEP 2.2.6 create the final error matrix:<a class="headerlink" href="#step-2-2-6-create-the-final-error-matrix" title="Permalink to this headline">¶</a></h3>
<p>The final error matrix is calculated at this step:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cur_lvl_glb_fcst_err</span> <span class="o">=</span> <span class="n">cur_inv_fft_err_glb</span><span class="o">*</span><span class="n">cur_inv_fft_err_glb</span>
<span class="n">cur_lvl_lam_fcst_err</span> <span class="o">=</span> <span class="n">cur_inv_fft_err_lam</span><span class="o">*</span><span class="n">cur_inv_fft_err_lam</span>

<span class="n">lvl_glb_fcst_err_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_lvl_glb_fcst_err</span><span class="p">)</span>
<span class="n">lvl_lam_fcst_err_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_lvl_lam_fcst_err</span><span class="p">)</span>
</pre></div>
</div>
<p>We go through the final error matrix for each valid time, and store the data
first in either <code class="docutils literal notranslate"><span class="pre">lvl_glb_fcst_err_list</span></code> or <code class="docutils literal notranslate"><span class="pre">lvl_lam_fcst_err_list</span></code>, and
then we average the errors as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lvl_glb_fcst_err</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lvl_glb_fcst_err_list</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">lvl_lam_fcst_err</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lvl_lam_fcst_err_list</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>For example, the shapes of <code class="docutils literal notranslate"><span class="pre">lvl_glb_fcst_err</span></code> and <code class="docutils literal notranslate"><span class="pre">lvl_lam_fcst_err</span></code>
are <code class="docutils literal notranslate"><span class="pre">(219537,</span> <span class="pre">1)</span></code></p>
</div>
</div>
<div class="section" id="step-2-3-best-linear-unbiased-estimator">
<h2>STEP 2.3 Best Linear Unbiased Estimator<a class="headerlink" href="#step-2-3-best-linear-unbiased-estimator" title="Permalink to this headline">¶</a></h2>
<div class="section" id="step-2-3-1-obtain-the-model-error-coefficient">
<h3>STEP 2.3.1 Obtain the model error coefficient<a class="headerlink" href="#step-2-3-1-obtain-the-model-error-coefficient" title="Permalink to this headline">¶</a></h3>
<p>The codes for BLUE is shown below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">err_componenet0</span> <span class="o">=</span> <span class="p">(</span><span class="n">lvl_glb_fcst_err</span> <span class="o">+</span> <span class="n">lvl_lam_fcst_err</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>For example, the shape of <code class="docutils literal notranslate"><span class="pre">err_componenet0</span></code> is <code class="docutils literal notranslate"><span class="pre">(219537,</span> <span class="pre">1)</span></code>. Then in order
to calculate BLUE fast, we convert the regular shape of <code class="docutils literal notranslate"><span class="pre">(219537,</span> <span class="pre">219537)</span></code>
(e.g., from <code class="docutils literal notranslate"><span class="pre">err_componenet0</span> <span class="pre">*</span> <span class="pre">err_componenet0</span></code>) to sparse matrix:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">matrix_length</span> <span class="o">=</span> <span class="n">lvl_lam_fcst_err</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">matrix_range</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">matrix_length</span><span class="p">))</span>

<span class="n">lvl_lam_fcst_err</span> <span class="o">=</span> <span class="n">csc_matrix</span><span class="p">(</span>
    <span class="p">(</span><span class="n">lvl_lam_fcst_err</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">matrix_length</span><span class="p">),</span> <span class="p">(</span><span class="n">matrix_range</span><span class="p">,</span> <span class="n">matrix_range</span><span class="p">)),</span>
    <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">matrix_length</span><span class="p">,</span> <span class="n">matrix_length</span><span class="p">))</span>

<span class="n">err_componenet0</span> <span class="o">=</span> <span class="n">csc_matrix</span><span class="p">(</span>
    <span class="p">(</span><span class="n">err_componenet0</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">matrix_length</span><span class="p">),</span> <span class="p">(</span><span class="n">matrix_range</span><span class="p">,</span> <span class="n">matrix_range</span><span class="p">)),</span>
    <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">matrix_length</span><span class="p">,</span> <span class="n">matrix_length</span><span class="p">))</span>
</pre></div>
</div>
<p>From the above codes, we have the shapes of <code class="docutils literal notranslate"><span class="pre">lvl_lam_fcst_err</span></code>
and <code class="docutils literal notranslate"><span class="pre">err_componenet0</span></code> as <code class="docutils literal notranslate"><span class="pre">(219537,</span> <span class="pre">219537)</span></code>. Then the coefficient from the errors is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">err_coef</span> <span class="o">=</span> <span class="n">lvl_lam_fcst_err</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">err_componenet0</span><span class="p">)</span>
<span class="n">all_err_coef</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_coef</span><span class="p">)</span>
</pre></div>
</div>
<p>The shape of <code class="docutils literal notranslate"><span class="pre">err_coef</span></code> is <code class="docutils literal notranslate"><span class="pre">(219537,</span> <span class="pre">219537)</span></code>, and <code class="docutils literal notranslate"><span class="pre">all_err_coef</span></code> is a list contains all levels.</p>
</div>
<div class="section" id="step-2-3-2-smooth-the-model-error-coefficient-over-levels">
<h3>STEP 2.3.2 Smooth the model error coefficient over levels:<a class="headerlink" href="#step-2-3-2-smooth-the-model-error-coefficient-over-levels" title="Permalink to this headline">¶</a></h3>
<p>The codes below show that how the model weight
(or called model error coefficient) is smoothed
(e.g., <code class="docutils literal notranslate"><span class="pre">model_weights</span></code> means <code class="docutils literal notranslate"><span class="pre">all_err_coef</span></code> from the above section):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">smooth_model_weights</span><span class="p">(</span><span class="n">model_weights</span><span class="p">,</span> <span class="n">total_model_levels</span><span class="p">,</span> <span class="n">gaussian_sigma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; using a gaussian filter to smooth the model weights&quot;&quot;&quot;</span>
    <span class="c1"># 1: extract the model weight diagnoal</span>
    <span class="n">model_weights_diag</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">lvl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_model_levels</span><span class="p">)):</span>
        <span class="n">model_weights_diag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_weights</span><span class="p">[</span><span class="n">lvl</span><span class="p">]</span><span class="o">.</span><span class="n">diagonal</span><span class="p">())</span>
    <span class="n">model_weights_diag_array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">model_weights_diag</span><span class="p">)</span>

    <span class="c1"># 2: filter the model weight diagnoals vertically</span>
    <span class="n">model_weights_diag_filtered</span> <span class="o">=</span> <span class="n">gaussian_filter1d</span><span class="p">(</span>
        <span class="n">model_weights_diag_array</span><span class="p">,</span> <span class="n">gaussian_sigma</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># 3: revert the diagnoals back to a sparse matrix</span>
    <span class="n">matrix_length</span> <span class="o">=</span> <span class="n">model_weights_diag_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">matrix_range</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">matrix_length</span><span class="p">))</span>

    <span class="n">smoothed_model_weights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">lvl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_model_levels</span><span class="p">)):</span>
        <span class="n">cur_model_weights</span> <span class="o">=</span> <span class="n">csc_matrix</span><span class="p">(</span>
            <span class="p">(</span><span class="n">model_weights_diag_filtered</span><span class="p">[</span><span class="n">lvl</span><span class="p">,</span> <span class="p">:],</span> <span class="p">(</span><span class="n">matrix_range</span><span class="p">,</span> <span class="n">matrix_range</span><span class="p">)),</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">matrix_length</span><span class="p">,</span> <span class="n">matrix_length</span><span class="p">))</span>
        <span class="n">smoothed_model_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_model_weights</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">smoothed_model_weights</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="step-2-4-running-analysis">
<h2>STEP 2.4 Running analysis<a class="headerlink" href="#step-2-4-running-analysis" title="Permalink to this headline">¶</a></h2>
<p>After we obtained the model error coefficient (BLUE),
we can run analysis using the current LAM and global model forecasts:</p>
<div class="section" id="step-2-4-1-obtain-the-current-fft-of-lam-and-global-forecasts-level-by-level">
<h3>STEP 2.4.1 obtain the current FFT of LAM and global forecasts level by level:<a class="headerlink" href="#step-2-4-1-obtain-the-current-fft-of-lam-and-global-forecasts-level-by-level" title="Permalink to this headline">¶</a></h3>
<p>The codes for obtaining the current FFT for both LAM and global forecasts are:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">lvl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">total_model_levels</span><span class="p">)):</span>
    <span class="n">cur_lvl_lam_data</span> <span class="o">=</span> <span class="n">lam_data</span><span class="p">[</span><span class="n">lvl</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">cur_lvl_glb_data</span> <span class="o">=</span> <span class="n">glb_data</span><span class="p">[</span><span class="n">lvl</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="p">(</span><span class="n">cur_lam_fft_coef</span><span class="p">,</span> <span class="n">power_spectrum_lam</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">fft_process</span><span class="o">.</span><span class="n">run_fft</span><span class="p">(</span><span class="n">cur_lvl_lam_data</span><span class="p">)</span>
    <span class="p">(</span><span class="n">cur_glb_fft_coef</span><span class="p">,</span> <span class="n">power_spectrum_glb</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">fft_process</span><span class="o">.</span><span class="n">run_fft</span><span class="p">(</span><span class="n">cur_lvl_glb_data</span><span class="p">)</span>
</pre></div>
</div>
<p>The following figures show <code class="docutils literal notranslate"><span class="pre">cur_lvl_lam_data</span></code> and <code class="docutils literal notranslate"><span class="pre">cur_lvl_glb_data</span></code> at the level 0:</p>
<a class="reference internal image-reference" href="_images/var_ana_lam.png"><img alt="_images/var_ana_lam.png" src="_images/var_ana_lam.png" style="width: 350px;" /></a>
<a class="reference internal image-reference" href="_images/var_ana_glb.png"><img alt="_images/var_ana_glb.png" src="_images/var_ana_glb.png" style="width: 350px;" /></a>
</div>
<div class="section" id="step-2-4-2-running-analysis">
<h3>STEP 2.4.2 running analysis:<a class="headerlink" href="#step-2-4-2-running-analysis" title="Permalink to this headline">¶</a></h3>
<p>If all the criteria of blending (e.g., the power difference is big enough,
and the background is not that wet) are met, we run the analysis as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cur_analysis_fft_coef</span> <span class="o">=</span> <span class="n">cur_model_weight</span><span class="o">*</span><span class="p">(</span>
    <span class="n">cur_glb_fft_coef_vector</span> <span class="o">-</span> <span class="n">cur_lam_fft_coef_vector</span><span class="p">)</span> <span class="o">+</span> \
    <span class="n">cur_lam_fft_coef_vector</span>

<span class="c1"># convert fft coef back to grid data</span>
<span class="n">cur_analysis</span> <span class="o">=</span> <span class="n">var_bld_process</span><span class="o">.</span><span class="n">freq2grid</span><span class="p">(</span>
    <span class="n">cur_analysis_fft_coef</span><span class="p">,</span> <span class="n">cur_lvl_lam_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
<p>Where <code class="docutils literal notranslate"><span class="pre">cur_model_weight</span></code> has the shape of <code class="docutils literal notranslate"><span class="pre">(219537,</span> <span class="pre">219537)</span></code>, and
<code class="docutils literal notranslate"><span class="pre">cur_glb_fft_coef_vector/cur_lam_fft_coef_vector</span></code> has the
shape of <code class="docutils literal notranslate"><span class="pre">(219537,</span> <span class="pre">1)</span></code>, Note that the grid data shape is <code class="docutils literal notranslate"><span class="pre">(519,</span> <span class="pre">423)</span></code>.</p>
<p>Then we can have the <cite>cur_analysis</cite> as:</p>
<a class="reference internal image-reference" href="_images/var_ana_ana.png"><img alt="_images/var_ana_ana.png" src="_images/var_ana_ana.png" style="width: 600px;" /></a>
</div>
<div class="section" id="step-2-4-3-difference-between-wrf-gfs-and-the-blended-analysis">
<h3>STEP 2.4.3 Difference between WRF, GFS and the blended analysis<a class="headerlink" href="#step-2-4-3-difference-between-wrf-gfs-and-the-blended-analysis" title="Permalink to this headline">¶</a></h3>
<p>Finally we can see the difference between WRF, GFS and the blended analysis:</p>
<a class="reference internal image-reference" href="_images/all_results_L0.png"><img alt="_images/all_results_L0.png" src="_images/all_results_L0.png" style="width: 700px;" /></a>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Step 2 run Variational blending</a><ul>
<li><a class="reference internal" href="#step-2-1-determine-the-model-blending-criteria">STEP 2.1 Determine the model blending criteria</a><ul>
<li><a class="reference internal" href="#step-2-1-1-obtain-lam-maximum-reflectivity">STEP 2.1.1 obtain LAM maximum reflectivity:</a></li>
<li><a class="reference internal" href="#step-2-1-2-obtain-welch-model-power-over-latitudes">STEP 2.1.2 obtain Welch model power over latitudes</a></li>
<li><a class="reference internal" href="#step-2-1-3-obtain-the-large-scale-power-ratio-over-the-total-power">STEP 2.1.3 Obtain the large scale power ratio over the total power:</a></li>
<li><a class="reference internal" href="#step-2-1-4-obtain-the-wet-ratio-over-lands">STEP 2.1.4 Obtain the wet ratio over lands</a></li>
<li><a class="reference internal" href="#step-2-1-5-blending-criteria">STEP 2.1.5 Blending criteria</a></li>
</ul>
</li>
<li><a class="reference internal" href="#step-2-2-load-model-data-the-model-errors-and-auxiliary-files">STEP 2.2 Load model data, the model errors and auxiliary files</a><ul>
<li><a class="reference internal" href="#step-2-2-1-load-model-forecasts">STEP 2.2.1 Load model forecasts</a></li>
<li><a class="reference internal" href="#step-2-2-2-compare-the-current-and-historical-power-differences-between-lam-and-global-models">STEP 2.2.2 Compare the current and historical power differences between LAM and global models</a><ul>
<li><a class="reference internal" href="#step-2-2-2-1-load-historical-power-difference-between-lam-and-global-models">STEP 2.2.2.1 Load historical power difference between LAM and global models</a></li>
<li><a class="reference internal" href="#step-2-2-2-2-load-current-power-difference-between-lam-and-global-models">STEP 2.2.2.2 Load current power difference between LAM and global models</a></li>
<li><a class="reference internal" href="#step-2-2-2-3-compare-the-historical-and-current-power-differences">STEP 2.2.2.3 Compare the historical and current power differences</a></li>
</ul>
</li>
<li><a class="reference internal" href="#step-2-2-3-load-model-errors">STEP 2.2.3 Load model errors</a></li>
<li><a class="reference internal" href="#step-2-2-4-load-user-defined-error-ratio-profile-and-update-model-errors">STEP 2.2.4 Load user defined error ratio profile and update model errors</a></li>
<li><a class="reference internal" href="#step-2-2-5-convert-model-errors-from-an-array-to-a-matrix">STEP 2.2.5 convert model errors from an array to a matrix</a></li>
<li><a class="reference internal" href="#step-2-2-6-create-the-final-error-matrix">STEP 2.2.6 create the final error matrix:</a></li>
</ul>
</li>
<li><a class="reference internal" href="#step-2-3-best-linear-unbiased-estimator">STEP 2.3 Best Linear Unbiased Estimator</a><ul>
<li><a class="reference internal" href="#step-2-3-1-obtain-the-model-error-coefficient">STEP 2.3.1 Obtain the model error coefficient</a></li>
<li><a class="reference internal" href="#step-2-3-2-smooth-the-model-error-coefficient-over-levels">STEP 2.3.2 Smooth the model error coefficient over levels:</a></li>
</ul>
</li>
<li><a class="reference internal" href="#step-2-4-running-analysis">STEP 2.4 Running analysis</a><ul>
<li><a class="reference internal" href="#step-2-4-1-obtain-the-current-fft-of-lam-and-global-forecasts-level-by-level">STEP 2.4.1 obtain the current FFT of LAM and global forecasts level by level:</a></li>
<li><a class="reference internal" href="#step-2-4-2-running-analysis">STEP 2.4.2 running analysis:</a></li>
<li><a class="reference internal" href="#step-2-4-3-difference-between-wrf-gfs-and-the-blended-analysis">STEP 2.4.3 Difference between WRF, GFS and the blended analysis</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="step1.html"
                        title="previous chapter">Step 1 Preparing model errors</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/step2.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="step1.html" title="Step 1 Preparing model errors"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">var_blending_docs 0.0.1 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, sijin.zhang.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.3.
    </div>
  </body>
</html>